# This workflow creates and updates a git tag named "latest".
# When a new tag with the name matching "Ubuntu*" is pushed to the repository,
# the "latest" tag is updated to the same commit as the newly pushed tag and
# a new GitHub Release is created as draft, pointing to the "latest" tag.
# The commits added between the previous "latest" and the current one are
# listed in an automatic changelog. Besides the source code, the latest PDB
# archives generated by the previous runs of the "build-wsl" workflow are
# uploaded as release assets.
#
# One human being must then edit the draft release to:
# - Change the release tag from "latest" to the originally pushed "Ubuntu*" tag
# - Clean up the changelog, if required,
# - Upload more assets, maybe?
# - Human things,
# - And then publish the release.
#
# It's important to make sure that the tag points to the exact same commit that
# generated the last app submited to the store.

name: Draft a new release
on:
  push:
    tags:
      - "Ubuntu**" # Preserving the existing naming convention.

jobs:
  on_tag:
    name: Prepare a release draft
    runs-on: ubuntu-latest
    steps:
      - name: Checkout wiki # The PDB archives are stored inside the wiki.
        uses: actions/checkout@v3
        with:
          repository: ubuntu/wsl.wiki
      - uses: "marvinpinto/action-automatic-releases@v1.2.1"
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          draft: true
          automatic_release_tag: latest
          files: debug-databases/debug-database-*.tar.zst
